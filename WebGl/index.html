<html>
    <head>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/pin/three@v0.128.0-SK0zhlI7UZNd0gIQdpJa/mode=imports/optimized/three.js';
        let camera, scene, renderer;
        let geometry, material, mesh, ground, groundgeometry, ground_material;
        var x = 0.0;
        function init() {
          $("#cameraTouchBox").hide();
          $("#movementTouchBox").hide();
        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 10 );
        camera.position.z = 0;
        camera.rotation.x = 0;
        camera.rotation.y = 0;
        scene = new THREE.Scene();
        geometry = new THREE.BoxGeometry( 0.1, 0.2, 0.2);
        material = new THREE.MeshNormalMaterial();
        ground_material = new THREE.MeshBasicMaterial({color: 0x0022dd,side: THREE.DoubleSide});
        groundgeometry = new THREE.PlaneGeometry(1, 1);
        mesh = new THREE.Mesh( geometry, material );
        ground = new THREE.Mesh(groundgeometry, ground_material);
        ground.position.y=-0.1;
        ground.rotation.x=-Math.PI/2;
        scene.add( mesh );
         mesh.position.z = -0.5
        scene.add( ground );
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.setAnimationLoop( animation );
        document.body.appendChild( renderer.domElement );
      }

function animation( time ) {
	renderer.render( scene, camera );
  if (cameraTouchMove == true){
    rotateCamera(movementX/-1000, movementY/-1000);
  }

}
let touchscreen = false;
document.addEventListener("mousemove", updateDisplay, false);
document.getElementById("cameraTouchBox").addEventListener("touchmove", updateDisplayTouch, false);
document.addEventListener("touchstart", function(e){touchscreen=true; $("#cameraTouchBox").show();$("#movementTouchBox").show()}, false);
document.getElementById("cameraTouchBox").addEventListener("touchstart", handleStart, false);
document.getElementById("cameraTouchBox").addEventListener("touchend", handleEnd, false);
var keysPressed = {};
document.addEventListener('keydown', (event) => {
   keysPressed[event.key] = true;
   camera.getWorldDirection(camera_global_direction);
   if (keysPressed['ArrowUp']) {
      camera.translateZ(-0.1);
   } if (keysPressed['ArrowRight']) {
       camera.translateX(0.1);
   }if (keysPressed['ArrowLeft']) {
       camera.translateX(-0.1);
   }if (keysPressed['ArrowDown']) {
    camera.translateZ(0.1);
   }
   if (keysPressed['w']) {
      camera.translateZ(-0.1);
   } if (keysPressed['d']) {
       camera.translateX(0.1);
   }if (keysPressed['a']) {
       camera.translateX(-0.1);
   }if (keysPressed['s']) {
    camera.translateZ(0.1);
   }
   if (keysPressed['z']) {
      
       console.log(camera_global_direction);
   }
});
document.addEventListener('keyup', (event) => {
   delete keysPressed[event.key];
});
function updateDisplay(e){
  var movementX = e.movementX || e.mozMovementX || 0;
  var movementY = e.movementY || e.mozMovementY ||  0;
  rotateCamera(movementX/-100, movementY/-100);
}
let touchLim = 40;
let movementX = 0;
let movementY = 0;
let cameraTouchMove = false;
function updateDisplayTouch(evt) {
  console.log("wykryto dotyk");
  console.log(initialTouchX,  initialTouchY);
  evt.preventDefault();
  var el = document.getElementsByTagName("canvas")[0];
 
  var touches = evt.changedTouches;

  for (var i = 0; i < touches.length; i++) {
        var idx = ongoingTouchIndexById(touches[i].identifier);

    if (idx >= 0) {
      let bounds = document.getElementById("cameraTouchBox").getBoundingClientRect();

    // var centerY = (document.documentElement.clientHeight - bounds.top)/2
    // var centerX = (document.documentElement.clientWidth - bounds.left)/2
    movementX = touches[i].clientX-initialTouchX;
    movementY = touches[i].clientY-initialTouchY;
    if (movementX>touchLim){ movementX = touchLim;}
    if (movementY>touchLim){ movementY = touchLim;}
    if (movementX<-touchLim){ movementX = -touchLim;}
    if (movementY<-touchLim){ movementY = -touchLim;}
      console.log(movementX, movementY);
      
      ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
      console.log(".");
    } else {
      console.log("can't figure out which touch to continue");
    }
  }
}
function ongoingTouchIndexById(idToFind) {
  for (var i = 0; i < ongoingTouches.length; i++) {
    var id = ongoingTouches[i].identifier;

    if (id == idToFind) {
      return i;
    }
  }
  return -1;    // not found
}
function copyTouch(touch) {
  return { identifier: touch.identifier, pageX: touch.pageX, pageY: touch.pageY };
}
var ongoingTouches = [];
var initialTouchX;
var initialTouchY;
function handleStart(evt) {
  evt.preventDefault();
  console.log("touchstart.");
  var touches = evt.changedTouches;
  cameraTouchMove = true;
  for (var i = 0; i < touches.length; i++) {
    console.log("touchstart:" + i + "...");
    ongoingTouches.push(copyTouch(touches[i]));
    initialTouchX = touches[i].clientX;
    initialTouchY= touches[i].clientY;
    
    console.log("touchstart:" + i + ".");
    
  }
}
function handleEnd(evt) {
  evt.preventDefault();
  console.log("touchend");
  var touches = evt.changedTouches;
  rotateCamera(movementX/-1000, movementY/-1000);
  cameraTouchMove = false;

  for (var i = 0; i < touches.length; i++) {
    var idx = ongoingTouchIndexById(touches[i].identifier);

    if (idx >= 0) {
      
      ongoingTouches.splice(idx, 1);  // remove it; we're done
    } else {
      console.log("can't figure out which touch to end");
    }
  }
}
onclick = function(e){console.log("YOU HAVE CLICKED");}
window.onload = init();
var global_axis_y = new THREE.Vector3(0,1,0);
var camera_global_direction = new THREE.Vector3();


function rotateCamera(hor, vert){
  camera.getWorldDirection(camera_global_direction);
  camera.rotateOnWorldAxis(global_axis_y, hor);
  if((camera_global_direction.angleTo(global_axis_y)<0.2&&vert>0) || (camera_global_direction.angleTo(global_axis_y)>3&&vert<0)){
    console.log("x rotation over");
  }else{
    camera.rotateX(vert);
  }
}

var canvas = document.querySelector('canvas');
        canvas.requestPointerLock = canvas.requestPointerLock ||canvas.mozRequestPointerLock;
        document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock;

        canvas.onclick = function() {
          if(touchscreen==false){
          canvas.requestPointerLock();
        }
      }
      </script>
      <style>
        canvas {
        position: absolute;
        width : 100vw;
        height : 100vh;
        top: 0px;
        left: 0px;
        padding : 0;
        border : none;
        background-color : black;
      }
      #cameraTouchBox{
        z-index: 100;
        position: absolute;
        right:5px;
        bottom: 5px;
        width: 27vw;
        height: 27vw;
        opacity: 33%;
        background-color: black;
        border-radius: 100vw;

        font-size: 10vw;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #movementTouchBox{
        z-index: 100;
        position: absolute;
        left:5px;
        bottom: 5px;
        width: 27vw;
        height: 27vw;
        opacity: 33%;
        background-color: black;
        border-radius: 100vw;

        font-size: 10vw;
        display: flex;
        align-items: center;
        justify-content: center;
      }      
      

      </style>
    </head>
    <body>
        
          
      <div id="cameraTouchBox"> üëÅÔ∏è </div>
      <div id="movementTouchBox"> üïπÔ∏è </div>
    </body>


</html>