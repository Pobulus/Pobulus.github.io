<!DOCTYPE html>
<html lang="en">
<head>
				<title>The Square-Editor</title>
				<meta charset="UTF-8">
				<link rel="stylesheet" href="style.css">
				<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
				<title>Page title</title>
				<script>
					beats = 0;
					var map = {
						"left": [],
						"right": [],
						"top": [],
						"beats": []  
					}
					var noise = new Audio("ksh.ogg");
					var colors = ["O", "P", "C", "G"];
					var colorsNeg = ["orange", "green", "cyan", "pink"];
					function addRow(num){
						for (var i = 0; i < num; i++) {
							$("table").append("<tr><td class=\"beat\">"+beats+"</td><td class=\"delay\"><input type=\"number\"></td><td class=\"l\" onclick=\"addPalette(this)\"></td><td class=\"t\" onclick=\"addPalette(this)\"></td><td class=\"r\" onclick=\"addPalette(this)\"></td><td onclick=\"remove(this)\">X</td><td onclick=\"insert(this)\">^</td><td onclick=\"insertAfter(this)\">v</td></tr>")
							beats = beats+1;
						}
					}
					function remove(obj){
						$(obj).parent().remove();
						beats = 0;
						$(".beat").each(function(){
							$(this).html(beats);
							beats=beats+1;
						});
					}
					function insert(obj){
						$(obj).parent().before("<tr><td class=\"beat\">"+beats+"</td><td class=\"delay\"><input type=\"number\"></td><td class=\"l\" onclick=\"addPalette(this)\"></td><td class=\"t\" onclick=\"addPalette(this)\"></td><td class=\"r\" onclick=\"addPalette(this)\"></td><td onclick=\"remove(this)\">X</td><td onclick=\"insert(this)\">^</td><td onclick=\"insertAfter(this)\">v</td></tr>");
						beats = 0;
						$(".beat").each(function(){
							$(this).html(beats);
							beats=beats+1;
						});
					}
					function insertAfter(obj){
						$(obj).parent().after("<tr><td class=\"beat\">"+beats+"</td><td class=\"delay\"><input type=\"number\"></td><td class=\"l\" onclick=\"addPalette(this)\"></td><td class=\"t\" onclick=\"addPalette(this)\"></td><td class=\"r\" onclick=\"addPalette(this)\"></td><td onclick=\"remove(this)\">X</td><td onclick=\"insert(this)\">^</td><td onclick=\"insertAfter(this)\">v</td></tr>");
						beats = 0;
						$(".beat").each(function(){
							$(this).html(beats);
							beats=beats+1;
						});
					}
					function xport(){
						$('#palette').remove()
						$("tr").each(function(){
							
							var cells = $(this).children();
							if(cells.length>6){
								
								map["beats"][cells[0].outerText] = cells[1].firstChild.value;
								// map["left"][cells[0].outerText] = cells[2].outerText;
								// map["top"][cells[0].outerText] = cells[3].outerText;
								// map["right"][cells[0].outerText] = cells[4].outerText;
							}
						})
						
						console.log(map);
					}
					function setColor(obj){
						$(obj).parent().parent().css("background", $(obj).css("color"));
						var beat = $(obj).parent().parent().parent().children()[0].outerText;
						if($(obj).parent().parent().hasClass("l"))map.left[beat]=$(obj).text();
						if($(obj).parent().parent().hasClass("t"))map.top[beat]=$(obj).text();
						if($(obj).parent().parent().hasClass("r"))map.right[beat]=$(obj).text();
						$("#palette").remove();
						
					}
					function removeColor(obj){
						$(obj).parent().parent().css("background", "");
						var beat = $(obj).parent().parent().parent().children()[0].outerText;
						if($(obj).parent().parent().hasClass("l"))map.left[beat]="";
						if($(obj).parent().parent().hasClass("t"))map.top[beat]="";
						if($(obj).parent().parent().hasClass("r"))map.right[beat]="";
						$("#palette").remove();
						
					}
					const header = "<div id=\"palette\">"
					var colorButtons = {
					"O": "<div class=\"clr\" style=\"color:var(--orange)\" onclick=\"setColor(this)\">O</div>",
					"P": "<div class=\"clr\" style=\"color:var(--pink)\" onclick=\"setColor(this)\">P</div>",
					"G":"<div class=\"clr\" style=\"color:var(--green)\" onclick=\"setColor(this)\">G</div>",
					"C":"<div class=\"clr\"  style=\"color:var(--cyan)\" onclick=\"setColor(this)\">C</div>",
					"N":"<div class=\"clr\"  style=\"color:var(--background)\" onclick=\"removeColor(this)\">N</div>"

					}
					function removeItemOnce(arr, value) {
						var index = arr.indexOf(value);
						if (index > -1) {
							arr.splice(index, 1);
						}
						return arr;
						}
					var counter = 0;
					var prevdelay = 0
					var dict;
					var TO;
					function play(){
						dict = map;
						clearBeat();
						counter = 0;
						clearTimeout(TO);
						if(dict.beats[counter]){
							
							prevdelay = parseInt(dict.beats[counter]);
							TO = setTimeout(moveBeat, prevdelay)
						}else console.log("No delay specified");
					}
					function moveBeat(){
						
						noise.play();
						$("tr").eq(counter+1).css("background", "red");
						window.scrollTo(0, $("tr").eq(counter+1).position().top);
						$("tr").eq(counter).css("background", "");
						counter = counter+1;
						console.log(counter);
						if(dict.beats[counter]){
							console.log(dict.beats[counter])
							prevdelay = parseInt(dict.beats[counter]);
						}
						if(counter<dict.beats.length) TO = setTimeout(moveBeat, prevdelay);
						else setTimeout(clearBeat, prevdelay);

					}
					function clearBeat(){
						$("tr").eq(counter).css("background", "");

					}
					function addPalette(obj){
						$("#palette").remove();
						$(obj).text("");
						var cells = $(obj).parent().parent().children();
						var toappend = header;
						// cells[2].outerText
						var colorsPossible = ["O", "P", "C", "G"];
						console.log(obj.className);
						var beat = $(obj).parent().children()[0].outerText;
						console.log(beat)
						if(Object.keys(colorButtons).includes(map.top[beat])){
								var v = colorsPossible.indexOf(map.top[beat]);
								if(v == 0||v==2){
								colorsPossible = removeItemOnce(colorsPossible, colors[0]);
								colorsPossible = removeItemOnce(colorsPossible, colors[2]);
								}else {
									colorsPossible = removeItemOnce(colorsPossible, colors[1]);
									colorsPossible = removeItemOnce(colorsPossible, colors[3]);
								}
						 }
						if(obj.className=="l"||obj.className=="r"){
							if(Object.keys(colorButtons).includes(map.right[beat])){
								colorsPossible = removeItemOnce(colorsPossible, map.right[beat]);
								var v = colors.indexOf(map.right[beat]);
								if(v ==0||v==2){
								colorsPossible = removeItemOnce(colorsPossible, colors[1]);
								colorsPossible = removeItemOnce(colorsPossible, colors[3]);
								}else {
									colorsPossible = removeItemOnce(colorsPossible, colors[0]);
									colorsPossible = removeItemOnce(colorsPossible, colors[2]);
								}
							}
							if(Object.keys(colorButtons).includes(map.left[beat])){
								colorsPossible = removeItemOnce(colorsPossible, map.left[beat]);
								var v = colors.indexOf(map.left[beat]);
								if(v == 0||v==2){
								colorsPossible = removeItemOnce(colorsPossible, colors[1]);
								colorsPossible = removeItemOnce(colorsPossible, colors[3]);
								}else {
									colorsPossible = removeItemOnce(colorsPossible, colors[0]);
									colorsPossible = removeItemOnce(colorsPossible, colors[2]);
								}
							}
						}
						if(obj.className=="t"){
							if(Object.keys(colorButtons).includes(map.right[beat])){
								var v = colors.indexOf(map.right[beat]);
								if(v == 0||v==2){
								colorsPossible = removeItemOnce(colorsPossible, colors[0]);
								colorsPossible = removeItemOnce(colorsPossible, colors[2]);
								}else {
									colorsPossible = removeItemOnce(colorsPossible, colors[1]);
									colorsPossible = removeItemOnce(colorsPossible, colors[3]);
								}
							}
							if(Object.keys(colorButtons).includes(map.left[beat])){
								var v = colors.indexOf(map.left[beat]);
								if(v == 0||v==2){
								colorsPossible = removeItemOnce(colorsPossible, colors[0]);
								colorsPossible = removeItemOnce(colorsPossible, colors[2]);
								}else {
									colorsPossible = removeItemOnce(colorsPossible, colors[1]);
									colorsPossible = removeItemOnce(colorsPossible, colors[3]);
								}
							}
						}

						
						for(var i=0; i<colorsPossible.length;i++){
							toappend = toappend+colorButtons[colorsPossible[i]];
						}
						toappend = toappend+colorButtons.N+"</div";
						$(obj).append(toappend);
					
					}
				</script>

	
	
	
	
	

</head>
<body >
	<table>
		<tr class="names">
			<td class="beatD">beat</td>
			<td>delay</td>
			<td>left</td>
			<td>top</td>
			<td>right			
			</td>

			<td colspan="3">Options</td>
		</tr>
	</table>

	<div id="controls" onclick="$('#palette').remove()">
		<div id="add" onclick="addRow(1)">+</div>
		<div id="add" onclick="addRow(10)">+10</div>
		<div id="add" onclick="addRow(100)">+100</div>
		<div id="add" onclick="xport()">✓</div>
		<div id="add" onclick="play()">▷</div>
		<div id="add" onclick="window.scrollTo({top: 0,left: 0,behavior: 'smooth'})">TOP</div>
	</div>
</body>
</html>
